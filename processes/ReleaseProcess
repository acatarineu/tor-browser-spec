#          Magical Tor Browser Release Process Incantations
#
#  "May this part of our job one day be replaced by a small shell script"
#

#. Tag any relevant component versions.
   # XXX: Depends on which components have been updated

#. Update changelog and versions file in tor-browser-bundle:
   cd gitian/tor-browser-bundle
   vim Bundle-Data/Docs/ChangeLog.txt
   cd gitian
   vim versions*
   git commmit ..
   git diff --color HEAD^1
   cd ../..

#. Tag a build tag in tor-browser-bundle.git
   . versions # Or versions.alpha/versions.beta
   git tag -s tbb-$TORBROWSER_VERSION-build1

#. Push tag and version to tor-browser-bundle.git   
   torsocks git push origin master:master
   torsocks git push origin --tags

#. Build:
   make
   make sign
   make match

#. Distribute build to tor-qa@lists.torproject.org
   #XXX: Currently manual

#. Clear out old builds, transfer builds to vescum
   torsocks ssh www-master.torproject.org "rm -rf /srv/www-master.torproject.org/htdocs/dist/torbrowser/3.5*"
   torsocks rsync -aP $TORBROWSER_VERSION www-master.torproject.org:/srv/www-master.torproject.org/htdocs/dist/torbrowser/
   torsocks ssh www-master.torproject.org "chmod g+w,o+r -R /srv/www-master.torproject.org/htdocs/dist/torbrowser/3.5*"
   torsocks ssh www-master.torproject.org "/home/mirroradm/bin/trigger-mirrors"

#. Sign individual bundle files
#  XXX: This blocks on Erinn currently. We use her key for file sigs

#. Update website's torbrowser versions file
   cd website
   torsocks svn up .
   vim ./include/versions.wmi
   torsocks svn commit include/versions.wmi -m "Bump TBB version"
   ./publish
   cd ..

#. Update recommended-versions file in torbrowser.git
   cd torbrowser
   git checkout maint-2.4
   torsocks git pull origin
   vim ./build-scripts/recommended-versions
   git commit build-scripts/recommended-versions
   git checkout master
   torsocks git pull origin
   git merge maint-2.4
   torsocks git push origin maint-2.4:maint-2.4
   torsocks git push origin master:master
   cd ..

#. Create blog post from changelog
#  XXX: Template?
#  See https://blog.torproject.org/blog/tor-browser-352-released for now
#  Don't forget to link to Mozilla's security advisories if this is a security
#  update, or Nadim will yell at you.
