#          Magical Tor Browser Release Process Incantations
#
#  "May this part of our job one day be replaced by a small shell script"
#

#. Tag any relevant component versions.
   # Depends on which components have been updated
   # If this is a firefox version update, you must rebase the patches, and
   # then:
   vim browser/config/version.txt config/milestone.txt
   git commit browser/config/version.txt config/milestone.txt -m "Bug 10895: Fix versioning for langpacks."
   # git tag and push..

#. Update changelog, updater relevant config and versions file in
#  tor-browser-bundle:
   cd gitian/tor-browser-bundle
   vim Bundle-Data/Docs/ChangeLog.txt
   vim tools/update-responses/config.yml
# No need to bother with old .xml and .htaccess files
   rm tools/update-resonses/htdocs/$TORBROWSER_UPDATE_CHANNEL/*
   cd gitian
   vim versions*
   git commmit ..
   git diff --color HEAD^1
   cd ../..

#. Tag a build tag in tor-browser-bundle.git
   . versions # Or versions.alpha/versions.beta
   git tag -s tbb-$TORBROWSER_VERSION-build1

#. Push tag and version to tor-browser-bundle.git   
   torsocks git push origin master:master
   torsocks git push origin --tags

#. Build:
   make
   make incrementals
   # XXX: it sucks to have to re-hash here
   make hash
   make sign
   make match

#. Place all build signatures in the correct location and fix permissions
   source versions
   for i in gk linus erinn mikeperry dcf
   do
     if [ -d ${TORBROWSER_VERSION}/$i ]; then
       if [ -f ${TORBROWSER_VERSION}/${i}/sha256sums.txt.asc ]; then
         cp ${TORBROWSER_VERSION}/$i/sha256sums.txt.asc ${TORBROWSER_VERSION]/sha256sums.txt-${i}.asc
       fi
       rm -rf ${TORBROWSER_VERSION/$i
     fi
   done
   chmod 755 $TORBROWSER_VERSION
   chmod 644 $TORBROWSER_VERSION/*

#. Distribute build to tor-qa@lists.torproject.org
   #XXX: Currently manual

#. Sign individual bundle files
#  XXX: This blocks on Erinn currently. We use her key for file sigs

#. Clear out old builds, transfer builds to staticiforme
#. Remote:
#  XXX: Be aware that this command would delete ALL Tor Browser 4.x.x versions!
   torsocks ssh staticiforme.torproject.org "rm -rf /srv/dist-master.torproject.org/htdocs/torbrowser/4.*"
   torsocks rsync -avP $TORBROWSER_VERSION staticiforme.torproject.org:/srv/dist-master.torproject.org/htdocs/torbrowser/
   torsocks ssh staticiforme.torproject.org "chmod g+w,o+r -R /srv/dist-master.torproject.org/htdocs/torbrowser/*"
   torsocks ssh staticiforme.torproject.org "static-update-component dist.torproject.org"
#. Local to staticiforme:
   cd /tmp
   wget -nH --cut-dirs=2 -r -l 1 https://people.torproject.org/~mikeperry/builds/$TORBROWSER_VERSION
   rm $TORBROWSER_VERSION/index.html*
#  $OLD_TORBROWSER_VERSION is the value for exactly the one version that should
#  get superseded by $TORBROWSER_VERSION.
   rm -rf /srv/dist-master.torproject.org/htdocs/torbrowser/$OLD_TORBROWSER_VERSION
   cd /srv/dist-master.torproject.org/htdocs/torbrowser/
   mv /tmp/$TORBROWSER_VERSION .
# We need to adjust permissions *after* we copied the new version to dist-master
   chmod 775 $TORBROWSER_VERSION
   chmod 664 $TORBROWSER_VERSION/*
   static-update-component dist.torproject.org

#. Update website's torbrowser versions file
   cd webwml
   torsocks git pull origin
   vim ./include/versions.wmi ./projects/torbrowser/RecommendedTBBVersions
   git commit include/versions.wmi projects/torbrowser/RecommendedTBBVersions -m "Bump TBB version"
   torsocks git push origin master:master
   cd ..

#. Create blog post from changelog
#  XXX: Template?
   See https://blog.torproject.org/blog/tor-browser-352-released for now
   Don't forget to link to Mozilla's security advisories if this is a security
   update, or Nadim will yell at you.

#. Update and upload new update responses for the updater
   cd tor-browser-bundle/gitian
   make update_responses # (or update_responses-alpha, update_responses-beta)
   cd ../tools/update-responses
   chmod 644 htdocs/$TORBROWSER_UPDATE_CHANNEL/*
   chmod 644 htdocs/$TORBROWSER_UPDATE_CHANNEL/.htaccess
   chmod 755 htdocs/$TORBROWSER_UPDATE_CHANNEL/
   torsocks rsync -av htdocs/$TORBROWSER_UPDATE_CHANNEL staticiforme.torproject.org:/srv/dist-master.torproject.org/htdocs/torbrowser/update_2/
   torsocks ssh staticiforme.torproject.org "static-update-component dist.torproject.org"

